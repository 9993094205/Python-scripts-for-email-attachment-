from ayx import Alteryx
import pandas as pd
from openpyxl import load_workbook
from openpyxl.worksheet.datavalidation import DataValidation

# Read incoming data from Alteryx
df = Alteryx.read("#1")

# Loop over unique approvers and save separate files
approvers = df['Approver'].unique()

for approver in approvers:
    approver_df = df[df['Approver'] == approver].copy()
    
    output_path = f"C:/Output/Approver_{approver}.xlsx"
    
    # Save to Excel
    approver_df.to_excel(output_path, index=False)

    # Reopen the file and add data validation
    wb = load_workbook(output_path)
    ws = wb.active

    # Create data validation
    dv = DataValidation(type="list", formula1='"Yes,No"', allow_blank=True)
    ws.add_data_validation(dv)

    # Assuming 'Approved' is the last column
    approved_col_letter = chr(65 + len(approver_df.columns) - 1)

    # Apply dropdown to all rows in 'Approved' column (starting from row 2)
    for row in range(2, len(approver_df) + 2):
        cell = f"{approved_col_letter}{row}"
        dv.add(ws[cell])

    wb.save(output_path)
